[TOC]

## 50 | 索引：如何在海量数据中快速查找某个数据？

- **类似 Redis 这个的 Key-Value 数据库中的索引，又是怎么实现的呢？底层依赖的又是什么数据结构呢？**

### 为什么需要索引

- 实际软件开发的本质：
    - 都可以抽象为“对数据的存储和计算”
    - 对应到数据结构和算法里。"存储"就是数据结构，“计算”就是算法。
- 对于**存储**的需求，功能上无外乎增删改查。
    - “**如何节省存储空间、如何提高数据增删改查的执行效率**”，就成了设计的重点。
    - 而这些系统的实现都离不开一个东西——**索引**。索引设计的好坏，直接决定了这些系统是否优秀。

### 索引的需求定义

- 一般从**功能性需求**和**非功能性需求**两方面来分析。

#### 1. 功能性需求

- **数据是格式化数据还是非格式化数据？**
    - 结构化数据
        - 如 MySQL 中的数据
    - 非结构化数据
        - 搜索引擎中的网页
        - 一般需要做预处理，提取查询关键词，对关键词构建索引
- **数据是静态数据还是动态数据？**
    - 静态数据
        - 在构建索引时，只需要考虑查询效率就可以了。
    - 动态数据
        - 不仅要考虑索引的查询效率，还需要支持动态数据集合的索引。
- **索引存储在内存还是硬盘？**
    - 内存
        - 速度快，
        - 空间有限
    - 硬盘
    - 一部分存储在内存，一部分存储在硬盘
        - 兼顾内存消耗和查询效率
- **单值查找还是区间查找？**
    - 单值
    - 区间
- **单关键词查找还是多关键词组合查找？**
    - 一个关键词
    - 多个关键词

#### 2. 非功能性需求

- **不管是存储在内存中还是磁盘中，索引对存储空间的消耗不能过大**
    - 有时候，索引对存储空间的消耗会超过原始数据。
- **考虑索引查询效率的同时，我们还需要考虑索引的维护成本**
    - 在原始数据动态增删改的同时，我们也需要动态的更新索引。而索引的更新势必会影响到增删改操作的性能。

### 构建索引常用的数据结构有哪些？

- 几种支持**动态数据集合**的数据结构。
    - **散列表**
        - 增删改查操作的性能非常好，时间复杂度是 O(1)。
        - 一些键值数据库，如 Redis、Memcache，就是用散列表来构建索引的。
        - 这类索引，一般都构建在内存中。
    - **红黑树**
        - 作为一种常用的平衡二叉树，数据插入、删除、查找的时间复杂度是 O(logn)，也非常适用来用构建内存索引。
        - Ext 文件系统中，对磁盘块的索引，用的就是红黑树。
    - **B+ 树**
        - 比起红黑树，更加适合构建存储在磁盘中的索引。
        - B+ 是一个多叉树，对相同个数的数据构建索引，B+ 树的高度要低于红黑树。
        - 当借助索引查询数据的时候，读取 B+ 树索引，需要的 IO 次数更少。
        - 所以，大部分关系数据库的索引，如 MySQL、Oracle都是用 B+ 树来实现的。
    - **跳表**
        - 支持快速添加、删除、查找数据。而且，我们通过灵活调整索引结点个数和数据个数间的比例，可以很好的平衡索引对内存的消耗及其查询效率。
        - Redis 中的有序集合，就是用跳表来构建的。
    - **布隆过滤器**
        - 有一定的判错率。
            - 对于判定存在的数据，有可能不存在，但，对于不存在的数据，那就肯定不存在。
        - 内存占用非常少。
        - 示例：
            - 构建一个布隆过滤器，并存储在内存中。
            - 当查询数据的时候，可以先通过布隆过滤器，判定是否存在。
                - 如果通过布隆过滤器判定数据不存在，那我们就没必要读取磁盘中的索引了。这样对于不存在的情况，数据查询就更加快速了。
- 静态数据结构
    - 把数据的关键词抽取出来，组织成有序数组，然后利用二分查找算法来快速查找数据。

### 总结引申

- 今天，我们从索引这个非常常用的技术方案，来展示了一些动态数据结构的应用场景。
- 架构设计离不开数据结构和算法。要成长为一个优秀的业务架构师、基础架构师，数据结构和算法的根基一定要打稳。

### 课后思考

1. 你知道基础系统、中间件、开源软件等系统中，有哪些用到了索引吗？这些索引又是如何实现的？

