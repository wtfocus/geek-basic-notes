[TOC]

## 52 | 算法实战（一）：剖析 Redis 常用数据类型对应的数据结构

- **今天，我们一起看下，经典数据库 Redis 中常用数据类型，底层都是用哪种数据结构实现的？**

### Redis 数据库介绍

- 是一个种 Key-Value 数据库。也被叫作**非关系型数据库**。
- 数据存储结构简单，读写效率非常高。
- 主要是作为内存数据库来使用的，数据存储在内存中。

### 字符串（String）

- 对应的数据结构里，就是**字符串**。

### 列表（list）

- 这种数据结构支持存储一组数据。

- 两种实现方法：
    - **压缩列表（ziplist）**
    - 双向循环链表
    
- 列表中**存储的数据量较小**的时候，列表就可以采用压缩列表的方式实现
    - 满足条件：
        - 列表中保存的单个数据（有可能是字符串类型）小于 64 字节。
        - 列表中数据个数少于 512 个
    - 压缩列表
        - Redis 自己设计的一种数据结构。
        - 使用连续的内存空间
        - 允许存储的数据大小不同（与数组区别）
        - ![img](https://static001.geekbang.org/resource/image/49/b5/49fd8d46eb94f463ace98717f11c2cb5.jpg)
        - “压缩”的理解
            - 相较于数组来说。
            - 如下图，数组的存储空间
            - ![img](https://static001.geekbang.org/resource/image/2e/69/2e2f2e5a2fe25d26dc2fc04cfe88f869.jpg)
        - 优点：
            - 节省内存
            - 支持不同类型数据的存储
            - 数据存储在一片连续的内存空间，通过键来获取值为列表的数据，读取效率非常高。
    
- 当列表中存储的数据量较大时，也就是不能满足刚刚讲的条件，列表就要通过**双向循环链表**来实现了

    - Redis 双向循环链表这种数据结构，额外定义了一个 list 结构体，来组织链表的首、尾指针，还有长度信息。

    - ```C
        // 以下是 C 语言代码，因为 Redis 是用 C 语言实现的。
        typedef struct listnode {
          struct listNode *prev;
          struct listNode *next;
          void *value;
        } listNode;
        
        
        typedef struct list {
          listNode *head;
          listNode *tail;
          unsigned long len;
          // .... 省略其他定义
        } list;
        
        ```

    - 

### 字典（hash）

- 用来存储一组数据对。每个数据对又包含键值两部分。
- 实现方式
    - 压缩列表
    - 散列表
- 数据量较小，使用压缩列表：
    - 满足条件：
        - 字典中保存的键和值都要小于 64 字节。
        - 字典中键值对个数要小于 512 个。
- 当不能同时满足上面两个条件时候，Redis 就使用**散列表**来实现字典类型。
    - Redis 使用 **MurmurHash2** 这种运行速度快、随机性好的哈希算法作为哈希函数。
    - 对于哈希冲突的问题，Redis 使用**链表法**来解决。
    - 除此外，Redis 还支持散列表的动态**扩容、缩容**。
        - 数据动态增加后，散列表的装载因子不停地变大。为了避免散列表性能的下降，当装载因子大于 1 的时候，Redis 会触发扩容，将散列表扩大为原来大小的 2 倍左右。
        - 数据动态减少后，为了节省内存，当装载因子小于 0.1 的时候，Redis 就会触发缩容，缩小为字典中数据个数大约 2 倍大小。
        - 扩容缩容要做大量的数据搬移和哈希值的重新计算，所以比较耗时。针对这个问题， Redis 使用我们`散列表（中）`讲的**渐近式扩容策略**，将数据的搬移分批进行，避免了大量数据一次性搬移导致的服务停顿。

### 集合（set）

- 用来存储一组不重复的数据。
- 实现方法：
    - 基于**有序数组**
    - 基于**散列表**
- 有序数组
    - 满足条件：
        - 存储的数据都是整数
        - 存储的数据元素个数不超过 512 个
- 散列表
    - 当不满足如上两个条件时

### 有序集合（sortedset）

- 存储一组数据，并且每个数据会附带一个得分。通过得分的大小，我们将数据组织成**跳表**这样的数据结构，以支持快速地按照得分、得分区间获取数据。
- 数据量较小的时候，Redis 会用**压缩列表**来实现有序集合
    - 满足条件：
        - 所有数据的大小都要小于 64 字节
        - 元素个数要小于 128 个

### 数据结构持久化

- 如果将数据结构持久化到硬盘？我们主要有两种解决思路：
    1. 清除原有存储结构，只将数据存储到磁盘中。
        - 当我们需要从磁盘中还原数据到内存的时候，再重新将数据组织成原来的数据结构。（Redis 采用的就是这种持久化思路）
        - 弊端：
            - 数据从硬盘还原到内存的过程，会耗用较多的时间。
    2. 保留原来的存储格式，将数据按照原有格式存储在磁盘中。

### 总结引申

- Redis 常用的数据类型底层依赖的数据结构，大概有五种
    - 压缩列表（一种特殊的数组）
    - 有序数组
    - 链表
    - 散列表
    - 跳表

### 课后思考

1. 在数据量较小的情况下，Redis 中的很多数据类型，都是通过多种数据结构来实现的。为什么这么设计呢？用一种固定的数据结构来实现不是更加简单吗？
2. 对于二叉查找树这种数据结构，我们如何将它持久化到磁盘中呢？