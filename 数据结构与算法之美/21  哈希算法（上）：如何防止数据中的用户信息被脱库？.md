[TOC]

## 21 | 哈希算法（上）：如何防止数据中的用户信息被脱库？

![](http://ww1.sinaimg.cn/large/006tNc79ly1g5jazaoy4wj30vq0hsjsd.jpg)

- **你会如何存储用户密码这么重要的数据吗？仅仅 MD5 加密一下存储就够了吗？**
- 今天我们会讲，**在实际开发中，我们该如何用哈希算法解决问题。**

### 什么是哈希算法？

- “散列” 或者 “哈希”，英文就是 “Hash”。
- “哈希算法” 叫 “Hash 算法” 或 “散列算法”。
- **定义 & 原理**
    - 将任意长度的二进制值串映射为固定长度的二进制值串，这个映射规则就是**哈希算法。**
    - 映射后得到的二进制值串就是**哈希值**。
- 一个优秀的哈希算法需满足如下几点要求：
    1. 从哈希值不能反向推导出原始数据（所以，哈希算法也叫单向哈希算法）
    2. 对输入数据非常敏感，哪怕原始数据只修改了一个 Bit，最后得到的哈希值也不大相同。
    3. 散列冲突的概率要很小，对于不同的原始数据，哈希值相同的概率非常小。
    4. 哈希算法的执行效率要尽量高效，针对较长文本，也能快速地计算出哈希值。

### 应用一：安全加密

- 常用于加密的哈希算法是 MD5(Message-Digest Algorithm，MD5 消息摘要算法) 和 SHA(Secure Hash Algorithm，安全散列算法)。

- 前面哈希算法的四点要求中，有两点格外重要：

    1. **很难根据哈希反向推导出原始数据**
        - 加密的目的就是防止原始数据泄露
    2. **散列冲突的概率要很小**
        - 尽量减少碰撞冲突的概率，理论上是没有办法做到完全不冲突的。为什么这么说呢？
        - 鸽巢原理（抽屉原理）
            - 10 个鸽巢，11 个鸽子。肯定有 2 只鸽子在 1 个鸽巢内。

- **为什么哈希算法无法做到零冲突？**

    - 哈希算法产生的哈希值的长度是固定且有限的。

    - 如 MD5 ，哈希值是固定 128 位二进制串，**能表示数据是限的**，最多能表示 2^128 个数据。而**哈希的数据是无穷的**。如果我们对 `2^128 + 1` 个数据求哈希值，就必然会存在哈希值相同的情况。

    - 哈希值超长的哈希算法，散列冲突的概率越低。

    - ```
        2^128=340282366920938463463374607431768211456
        ```

- 即便哈希算法存在冲突，但，哈希值的范围很大，冲突的概率极低，所以相对来说，还是很难破解的。

### 应用二：唯一标识

- 在海量图库中，搜索一张图是否存在。有如下方法，依次优化
    1. 拿图片的二进制串，一一去对比。
    2. 从二进制串中，取前 100 位，中间 100 位，后 100 位。通过哈希算法，得到一个哈希字符串，做图片唯一标识，来判断比较。
    3. 把每个图片的唯一标识存在散列表中，在散列表中查这个唯一标识。
        1. 如果不存在，说明图片不在图库。
        2. 如果找到，再去进行全量对比（缓存思想），看是否完全一样。

### 应用三：数据校验

- BT 下载软件下载原理是基于 P2P 协议。
- 我们会从多个机器上并行下载一个 2G 的电影，这个文件可能会分成很多文件块（比如 100 个，每个 20 MB）。等全部下载完成后，再组装成一个完整的电影文件。
- 那我们是**如何校验这些文件块的呢？**（这里只说其中一个思路）
    - 对 100 个文件块分别取哈希值，保存在种子文件中。
    - 当文件下载完成后，通过相同的哈希算法，对下载好的文件块逐一求哈希值，然后跟种子文件中保存的哈希值对比。

### 应用四：散列函数

- 散列函数也是哈希算法的一种应用。
- 相对哈希算法的其他应用，**散列函数对于散列算法冲突要求很低**。即便出现个别冲突，只要不过于严重，我们都可以通过开放寻址和链表法解决。
- 散列函数中更加关注散列后的值**是否能平均分布**，也就是，一组数据是否能均匀的散列在各个槽中。
- 散列函数用的散列算法一般都比较简单，**比较追求效率**。

### 解决开篇

- 在 MD5 的基础上，为防止字典攻击。这里引入一个“盐”的思想。
    - 用它来跟用户密码组合在一起，增加密码复杂度。我们拿到组合后的字符串来做哈希算法加密。
- 安全和攻击是和种相互博弈的关系，不存在绝对的安全。所以有安全措施，只是增加攻击的成本而已。

###  内容小结

- 今天我们讲到哈希算法的四个应用场景
    1. 唯一标识，哈希算法可以对大数据做信息摘要，通过一个较短的二进制编码来表示很大的数据。
    2. 校验数据完整性和正确性。
    3. 安全加密，这里需要权衡安全性和计算时间，来决定选用哪种哈希算法。
    4. 散列函数，它对哈希算法非常特别，它更加看重散列的平均性和哈希算法的执行效率。

### 课后思考

- 区块链使用的是哪种哈希算法？是为了解什么问题而使用的呢？

#### 精选一

- 区块链是一块块区块组成的，每个区块分为两部分：
    - 区块头
    - 区块体
- 区块头保存自己区块体和上一个区块头的哈希值。
- 因为这种链式关系和哈希值的唯一性，只要区块链上任意一个区块被修改过，后面所有区块保存的哈希值就不对了。
- 区块链使用的是 SHA256 哈希算法，计算哈希值非常耗时，如果要篡改一个区块，就必须重新计算该区块后面所有的区块的哈希值，短时间内几乎不可能做到。

